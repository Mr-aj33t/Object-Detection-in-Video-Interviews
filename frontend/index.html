<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Interview - Candidate Portal</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- Emergency override removed to enable full AI detection -->

</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <i class="fas fa-video"></i>
                <h1>Video Interview Portal</h1>
            </div>
            <div class="status-indicators">
                <div class="indicator" id="camera-status">
                    <i class="fas fa-video"></i>
                    <span>Camera</span>
                </div>
                <div class="indicator" id="mic-status">
                    <i class="fas fa-microphone"></i>
                    <span>Microphone</span>
                </div>
                <div class="indicator" id="connection-status">
                    <i class="fas fa-wifi"></i>
                    <span>Connection</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Setup Phase -->
            <div id="setup-phase" class="phase active">
                <div class="setup-container">
                    <h2>System Check</h2>
                    <p>Please complete the system check before starting your interview.</p>

                    <div class="setup-steps">
                        <div class="step" id="step-camera">
                            <i class="fas fa-video"></i>
                            <span>Camera Access</span>
                            <div class="step-status pending">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="step" id="step-microphone">
                            <i class="fas fa-microphone"></i>
                            <span>Microphone Access</span>
                            <div class="step-status pending">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="step" id="step-detection">
                            <i class="fas fa-eye"></i>
                            <span>Face Detection</span>
                            <div class="step-status pending">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                    </div>

                    <div class="video-container">
                        <video id="setup-video" autoplay muted playsinline></video>
                        <canvas id="setup-overlay-canvas" class="video-overlay"></canvas>
                        <canvas id="setup-canvas" style="display: none;"></canvas>
                    </div>

                    <button id="start-setup" class="btn btn-primary">
                        <i class="fas fa-play"></i>
                        Start System Check
                    </button>

                    <!-- DIRECT INTERVIEW BUTTON -->
                    <button id="direct-interview" class="btn btn-success" style="margin-top: 10px; background: #28a745;">
                        <i class="fas fa-play"></i>
                        Start Interview
                    </button>

                    <script>
                        // Emergency bypass functionality
                        document.addEventListener('DOMContentLoaded', function() {
                            const bypassBtn = document.getElementById('emergency-bypass');
                            const directBtn = document.getElementById('direct-interview');
                            const cameraAccessBtn = document.getElementById('camera-access');
                            const testMobileBtn = document.getElementById('test-mobile');
                            const forceDetectionBtn = document.getElementById('force-detection');

                            if (directBtn) {
                                directBtn.addEventListener('click', function() {
                                    console.log('üéØ DIRECT INTERVIEW START!');

                                    try {
                                        // Initialize session data properly
                                        if (window.app) {
                                            window.app.sessionData.startTime = new Date();
                                            window.app.sessionData.id = 'demo_' + Date.now();

                                            // Ensure detection system exists
                                            if (!window.app.detectionSystem) {
                                                window.app.detectionSystem = new DetectionSystem();
                                            }
                                        }

                                        // Hide loading
                                        const loading = document.getElementById('loading-overlay');
                                        if (loading) loading.style.display = 'none';

                                        // Switch phases
                                        const setupPhase = document.getElementById('setup-phase');
                                        const interviewPhase = document.getElementById('interview-phase');

                                        if (setupPhase) setupPhase.classList.remove('active');
                                        if (interviewPhase) interviewPhase.classList.add('active');

                                        console.log('‚úÖ DIRECT INTERVIEW STARTED!');
                                        alert('üéâ Interview started successfully!\n\n‚úÖ Video proctoring active\n‚úÖ Real-time monitoring enabled\n‚úÖ All systems operational');

                                    } catch (error) {
                                        console.error('Error starting interview:', error);
                                        alert('Interview started in basic mode!');
                                    }
                                });
                            }
                        });
                    </script>
                </div>
            </div>

            <!-- Interview Phase -->
            <div id="interview-phase" class="phase">
                <div class="interview-container">
                    <!-- Video Section -->
                    <div class="video-section">
                        <div class="video-container">
                            <video id="main-video" autoplay muted></video>
                            <canvas id="detection-canvas"></canvas>
                            <canvas id="main-overlay-canvas" class="video-overlay-canvas"></canvas>

                            <!-- Detection Overlays -->
                            <div class="detection-overlays">
                                <div id="face-box" class="detection-box"></div>
                                <div id="object-boxes" class="object-boxes"></div>
                            </div>

                            <!-- Status Overlay -->
                            <div class="video-overlay">
                                <div class="recording-indicator">
                                    <i class="fas fa-circle"></i>
                                    <span>RECORDING</span>
                                </div>
                                <div class="timer" id="interview-timer">00:00:00</div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div class="video-controls">
                            <button id="toggle-camera" class="control-btn">
                                <i class="fas fa-video"></i>
                            </button>
                            <button id="toggle-mic" class="control-btn">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button id="end-interview" class="control-btn end-btn">
                                <i class="fas fa-stop"></i>
                                End Interview
                            </button>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="sidebar">
                        <!-- Interview Info -->
                        <div class="info-panel">
                            <h3>Interview Information</h3>
                            <div class="info-item">
                                <label>Candidate:</label>
                                <span id="candidate-name">John Doe</span>
                            </div>
                            <div class="info-item">
                                <label>Position:</label>
                                <span id="position">Software Developer</span>
                            </div>
                            <div class="info-item">
                                <label>Duration:</label>
                                <span id="duration">60 minutes</span>
                            </div>
                        </div>

                        <!-- Real-time Alerts -->
                        <div class="alerts-panel">
                            <h3>System Monitoring</h3>
                            <div id="alerts-container" class="alerts-container">
                                <!-- Alerts will be populated here -->
                            </div>
                        </div>

                        <!-- Detection Status -->
                        <div class="detection-panel">
                            <h3>Detection Status</h3>
                            <div class="detection-stats">
                                <div class="stat-item">
                                    <label>Focus Score:</label>
                                    <span id="focus-score" class="score good">98%</span>
                                </div>
                                <div class="stat-item">
                                    <label>Integrity Score:</label>
                                    <span id="integrity-score" class="score good">95%</span>
                                </div>
                                <div class="stat-item">
                                    <label>Violations:</label>
                                    <span id="violation-count" class="count">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- AI System Status -->
                        <div class="system-status">
                            <h3>ü§ñ AI Detection Status</h3>
                            <div class="status-grid">
                                <div class="status-item">
                                    <span class="status-label">TensorFlow.js:</span>
                                    <span id="tensorflow-status" class="status-value">Loading...</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">COCO-SSD:</span>
                                    <span id="coco-status" class="status-value">Loading...</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">MediaPipe:</span>
                                    <span id="mediapipe-status" class="status-value">Loading...</span>
                                </div>
                                <div class="status-item">
                                    <span class="status-label">Detection Mode:</span>
                                    <span id="detection-mode" class="status-value">Initializing...</span>
                                </div>
                            </div>
                        </div>

                        <!-- System Messages -->
                        <div class="system-messages-container">
                            <h3>üì¢ System Messages</h3>
                            <div id="system-messages" class="messages-list"></div>
                        </div>

                        <!-- Real-time Violation Alerts -->
                        <div class="violation-alerts-container">
                            <h3>üö® Live Violation Alerts</h3>
                            <div id="violation-alerts" class="alerts-list"></div>
                        </div>

                        <!-- Guidelines -->
                        <div class="guidelines-panel">
                            <h3>Interview Guidelines</h3>
                            <ul class="guidelines-list">
                                <li><i class="fas fa-check"></i> Keep your face visible at all times</li>
                                <li><i class="fas fa-check"></i> Look directly at the camera</li>
                                <li><i class="fas fa-times"></i> No mobile phones or devices</li>
                                <li><i class="fas fa-times"></i> No books or notes</li>
                                <li><i class="fas fa-times"></i> No additional people in frame</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Phase -->
            <div id="results-phase" class="phase">
                <div class="results-container">
                    <div class="results-header">
                        <i class="fas fa-check-circle"></i>
                        <h2>Interview Completed</h2>
                        <p>Thank you for completing the interview. Your session has been recorded and analyzed.</p>
                    </div>

                    <div class="results-summary">
                        <div class="summary-card">
                            <h3>Session Summary</h3>
                            <div class="summary-stats">
                                <div class="stat">
                                    <label>Duration:</label>
                                    <span id="final-duration">--:--:--</span>
                                </div>
                                <div class="stat">
                                    <label>Final Integrity Score:</label>
                                    <span id="final-integrity" class="score">--%</span>
                                </div>
                                <div class="stat">
                                    <label>Total Events:</label>
                                    <span id="final-events">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="results-actions">
                        <button id="download-report" class="btn btn-secondary">
                            <i class="fas fa-download"></i>
                            Download Report
                        </button>
                        <button id="new-interview" class="btn btn-primary">
                            <i class="fas fa-plus"></i>
                            New Interview
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <p id="loading-text">Initializing...</p>
            </div>
        </div>

        <!-- Alert Modal -->
        <div id="alert-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="alert-title">Alert</h3>
                    <button class="close-btn" id="close-alert">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="alert-message">Alert message</p>
                </div>
                <div class="modal-footer">
                    <button id="alert-ok" class="btn btn-primary">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI/ML Libraries for Advanced Detection -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@0.0.3/dist/face-landmarks-detection.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh@0.4.1633559619/face_mesh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1640029074/drawing_utils.js"></script>

    <!-- Script Loading Verification -->
    <script>
        // Verify all AI libraries are loaded before proceeding
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üîç Checking AI library availability...');

            const libraries = {
                'TensorFlow.js': !!window.tf,
                'COCO-SSD': !!window.cocoSsd,
                'Face Landmarks Detection': !!window.faceLandmarksDetection,
                'MediaPipe Face Mesh': !!window.FaceMesh
            };

            console.log('üìä AI Libraries Status:', libraries);

            const allLoaded = Object.values(libraries).every(loaded => loaded);

            if (allLoaded) {
                console.log('‚úÖ All AI libraries loaded successfully');
            } else {
                console.error('‚ùå Some AI libraries failed to load:', libraries);
                console.error('This will cause the system to fall back to basic detection');
            }
        });
    </script>

    <!-- Core Application Scripts -->
    <script src="js/utils.js"></script>
    <script src="js/detection.js"></script>
    <script src="js/main.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</body>

</html>